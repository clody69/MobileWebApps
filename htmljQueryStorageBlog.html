<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js' lang='en'>
<!-- <![endif] -->
<head>
<meta charset='utf-8' />
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible' />
<title>
Mobile Web Applications Develeopment with HTML5
</title>
<meta content='A course on developing mobile web applications with HTML5' name='description' />
<meta content='Claudio Riva' name='author' />
<meta content='width=1024, user-scalable=no' name='viewport' />
<!-- Core and extension CSS files -->
<link href='css/documentation.css' rel='stylesheet' />
<link href='css/coderay_dark.css' rel='stylesheet' />
<!-- /%link(href="css/pygments.css" rel="stylesheet") -->
</head>
<body>
<div id='main'>
<div id='header-wrapper'>
<div class='basic' id='header'>
<div class='title'>
Mobile Web Applications Development with HTML5
</div>
</div>
</div>
<div id='menu'>
<ul>
<li>
<a href='index.html#'>Home</a>
</li>
<li>
<a href='index.html#Lectures'>Lectures</a>
</li>
<li>
<a href='index.html#Schedule'>Schedule</a>
</li>
<li>
<a href='index.html#Examples'>Examples</a>
</li>
<li>
<a href='index.html#Assignment'>Assignment</a>
</li>
<li>
<a href='index.html#Resources'>Resources</a>
</li>
<li>
<a href='index.html#About'>About</a>
</li>
</ul>
</div>
<div id='wrapper'>
<div class='content-wrapper'>
<h1>Adding the Options page to the Blog</h1><div class='actions'><a href='https://github.com/clody69/MobileWebAppsExamples/tree/master/htmljQueryStorageBlog'>Browse Source Code</a></div>
<p>
We add an Options page to the example
<a href='htmljQueryMultiBlog.html'>htmljQueryMultiBlog</a>
that allows the user to store his/her name and email in the local storage of the brwoser.
The data is stored in the localStorage so it is available after a browser restart. The fields are automatically attached
to each new entry that is sent to the server.
</p>
<p>
The first step is to add one additional page with id<span class='terminal'>
options
</span>to the structure of the web app.
</p>
<div class='code_block'>
<div class='code_header'>
views/index.haml
</div>
<div class="CodeRay">
  <div class="code"><pre><span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">home</span><span class="delimiter">&quot;</span></span>)&#x000A;  = haml <span class="symbol">:header</span>&#x000A;  &#x000A;  <span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)&#x000A;    = haml <span class="symbol">:posts</span>&#x000A;  &#x000A;  = haml <span class="symbol">:footer</span>&#x000A;&#x000A;<span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">new</span><span class="delimiter">&quot;</span></span>)&#x000A;  = haml <span class="symbol">:header</span>&#x000A;  &#x000A;  <span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)&#x000A;    = haml <span class="symbol">:new</span>&#x000A;  &#x000A;  =haml <span class="symbol">:footer</span>      &#x000A;&#x000A;<span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">options</span><span class="delimiter">&quot;</span></span>)&#x000A;&#x000A;  =haml <span class="symbol">:options</span>&#x000A;&#x000A;  =haml <span class="symbol">:footer</span>&#x000A;</pre></div>
</div>
</div>
<p>
The content of the new page is defined in the following file. It contains the form for the fields that we want to store in the localStorage.
</p>
<div class='code_block'>
<div class='code_header'>
views/options.haml
</div>
<div class="CodeRay">
  <div class="code"><pre><span class="tag">%div</span>(<span class="attribute-name">data-role</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-position</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">inline</span><span class="delimiter">&quot;</span></span>)&#x000A;  <span class="tag">%a</span>(<span class="attribute-name">href</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">#home</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delete</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">back</span><span class="delimiter">&quot;</span></span>) Cancel&#x000A;  <span class="tag">%h1</span> Options&#x000A;  <span class="tag">%a</span>(<span class="attribute-name">href</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">#home</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">check</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-theme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">saveOpt</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">back</span><span class="delimiter">&quot;</span></span>) Save&#x000A;  &#x000A;<span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)&#x000A;  <span class="tag">%form</span>&#x000A;    <span class="tag">%input</span>(<span class="attribute-name">type</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Name</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%input</span>(<span class="attribute-name">type</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">optEmail</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">Email</span><span class="delimiter">&quot;</span></span>)   &#x000A;</pre></div>
</div>
</div>
<p>
We also modify the page for creating a new entry (new.haml). We remove the field<span class='terminal'>
email
</span>and the url for posting the form. We'll post the new entry using our own javascript.
</p>
<div class='code_block'>
<div class='code_header'>
views/new.haml
</div>
<div class="CodeRay">
  <div class="code"><pre><span class="tag">%form</span>&#x000A;  <span class="tag">%input</span>(<span class="attribute-name">type</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Post Title</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">required</span>)&#x000A;  <span class="tag">%textarea</span>(<span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rows</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">Content</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)&#x000A;  <span class="tag">%button</span><span class="constant">#postEntry</span>(<span class="attribute-name">type</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>) Post&#x000A;</pre></div>
</div>
</div>
<p>
The last step is to add the javascript logic. We make the following three changes:
<ul>
<li>When the document is loaded and ready we copy the values of name and email into the fields of the options page.</li>
<li>
In the handler that is invoked when creating a new entry (by clicking on the button<span class='terminal'>
#postEntry
</span>) we add the code for posting the fields to the server.
</li>
<li>Add the logic for storing the fields in the localStorage when the options are saved</li>
</ul>
</p>
<p>
Note also the validation now is scoped to the individual pages by using the css selectors<span class='terminal'>
"#new .invalid"
</span>and<span class='terminal'>
"#options .invalid"
</span></p>
<div class='code_block'>
<div class='code_header'>
views/layout.haml
</div>
<div class="CodeRay">
  <div class="code"><pre> <span class="predefined">$</span>(<span class="keyword">function</span>() {&#x000A;  <span class="comment">// Assign the options from the local storage</span>&#x000A;  <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#optName</span><span class="delimiter">&quot;</span></span>).val(localStorage.name);&#x000A;  <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#optEmail</span><span class="delimiter">&quot;</span></span>).val(localStorage.email);&#x000A;    &#x000A;  <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#postEntry</span><span class="delimiter">&quot;</span></span>).bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">click</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span>() {&#x000A;    e.preventDefault();&#x000A;    <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#new .invalid</span><span class="delimiter">&quot;</span></span>).removeClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="keyword">if</span> (<span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#new :invalid</span><span class="delimiter">&quot;</span></span>).length) {&#x000A;      <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#new :invalid</span><span class="delimiter">&quot;</span></span>).addClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid</span><span class="delimiter">&quot;</span></span>);&#x000A;      <span class="keyword">return</span> <span class="predefined-constant">false</span>;&#x000A;    }&#x000A;    <span class="keyword">var</span> msg = {};&#x000A;    msg[<span class="string"><span class="delimiter">'</span><span class="content">title</span><span class="delimiter">'</span></span>] = <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#title</span><span class="delimiter">'</span></span>).val();&#x000A;    msg[<span class="string"><span class="delimiter">'</span><span class="content">content</span><span class="delimiter">'</span></span>] = <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#content</span><span class="delimiter">'</span></span>).val();&#x000A;    msg[<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>] = localStorage.email;&#x000A;    msg[<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>] = localStorage.name;&#x000A;    <span class="predefined">$</span>.post(<span class="string"><span class="delimiter">'</span><span class="content">/new</span><span class="delimiter">'</span></span>, msg, <span class="keyword">function</span>() {&#x000A;      <span class="predefined">$</span>.mobile.changePage(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>, {<span class="key">reloadPage</span>: <span class="predefined-constant">true</span>});&#x000A;    });&#x000A;  });&#x000A;  <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">[contenteditable]</span><span class="delimiter">&quot;</span></span>).focus(<span class="keyword">function</span>() {&#x000A;    <span class="keyword">var</span> <span class="predefined">$this</span> = <span class="predefined">$</span>(<span class="local-variable">this</span>);&#x000A;    <span class="predefined">$this</span>.data(<span class="string"><span class="delimiter">'</span><span class="content">before</span><span class="delimiter">'</span></span>, <span class="predefined">$this</span>.html());&#x000A;    <span class="keyword">return</span> <span class="predefined">$this</span>;          &#x000A;  });&#x000A;  <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">[contenteditable]</span><span class="delimiter">&quot;</span></span>).live(<span class="string"><span class="delimiter">'</span><span class="content">blur</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>() {&#x000A;      <span class="keyword">var</span> <span class="predefined">$this</span> = <span class="predefined">$</span>(<span class="local-variable">this</span>);&#x000A;      <span class="keyword">if</span> (<span class="predefined">$this</span>.data(<span class="string"><span class="delimiter">'</span><span class="content">before</span><span class="delimiter">'</span></span>) !== <span class="predefined">$this</span>.html()) {&#x000A;          <span class="predefined">$this</span>.data(<span class="string"><span class="delimiter">'</span><span class="content">before</span><span class="delimiter">'</span></span>, <span class="predefined">$this</span>.html());&#x000A;          <span class="predefined">$this</span>.trigger(<span class="string"><span class="delimiter">'</span><span class="content">change</span><span class="delimiter">'</span></span>);&#x000A;          <span class="comment">//alert($this.attr('data-id'));</span>&#x000A;          <span class="keyword">var</span> msg = {};&#x000A;          msg[<span class="string"><span class="delimiter">'</span><span class="content">id</span><span class="delimiter">'</span></span>] = <span class="predefined">$this</span>.attr(<span class="string"><span class="delimiter">'</span><span class="content">data-id</span><span class="delimiter">'</span></span>);&#x000A;          msg[<span class="predefined">$this</span>.attr(<span class="string"><span class="delimiter">'</span><span class="content">data-name</span><span class="delimiter">'</span></span>)] = <span class="predefined">$this</span>.html();&#x000A;          <span class="predefined">$</span>.post(<span class="string"><span class="delimiter">'</span><span class="content">/update</span><span class="delimiter">'</span></span>, msg);&#x000A;      }&#x000A;      <span class="keyword">return</span> <span class="predefined">$this</span>;&#x000A;  });   &#x000A;  &#x000A;  <span class="comment">//Save the options in the local storage     </span>&#x000A;  <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#saveOpt</span><span class="delimiter">&quot;</span></span>).bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">click</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span>() {&#x000A;    <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#options .invalid</span><span class="delimiter">&quot;</span></span>).removeClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="keyword">if</span> (<span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#options :invalid</span><span class="delimiter">&quot;</span></span>).length) {&#x000A;      <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#options :invalid</span><span class="delimiter">&quot;</span></span>).addClass(<span class="string"><span class="delimiter">&quot;</span><span class="content">invalid</span><span class="delimiter">&quot;</span></span>);&#x000A;      <span class="keyword">return</span> <span class="predefined-constant">false</span>;&#x000A;    }&#x000A;    localStorage.name = <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#optName</span><span class="delimiter">&quot;</span></span>).val();&#x000A;    localStorage.email = <span class="predefined">$</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#optEmail</span><span class="delimiter">&quot;</span></span>).val();&#x000A;    &#x000A;  })          &#x000A;})&#x000A;</pre></div>
</div>
</div>
<p>
You can try this example by starting the server and visiting the page
<a href='http://localhost:4567'>http://localhost:4567</a>
in your browser
</p>
<div class='code_block'>
<div class='code_header'>
terminal
</div>
<div class="CodeRay">
  <div class="code"><pre>ruby server.rb</pre></div>
</div>
</div>

</div>
</div>
</div>
<div id='footer'>
<div class='sponsor'>
<a href='http://www.aalto.fi/'><img src='imgs/aaltouni.png' /></a>
<a href='http://aaltovg.com'><img src='imgs/aaltovg.png' /></a>
<a href='http://aaltoes.com/'><img src='imgs/aaltoes.png' /></a>
<a href='http://www.nokia.com/'><img src='imgs/nokia.png' /></a>
<a href='http://www.f-secure.com/'><img src='imgs/f-secure.png' /></a>
</div>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]> ><! <![endif]-->
<html class='no-js' lang='en'>
<!-- <![endif] -->
<head>
<meta charset='utf-8' />
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible' />
<title>
Mobile Web Applications Develeopment with HTML5
</title>
<meta content='A course on developing mobile web applications with HTML5' name='description' />
<meta content='Claudio Riva' name='author' />
<meta content='width=1024' name='viewport' />
<!-- Core and extension CSS files -->
<link href='css/documentation.css' rel='stylesheet' />
<link href='css/coderay_dark.css' rel='stylesheet' />
<!-- /%link(href="css/pygments.css" rel="stylesheet") -->
<script type='text/javascript'>
  //<![CDATA[
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="http://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
  //]]>
</script>
<script type='text/javascript'>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29188416-1']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  //]]>
</script>
<script type='text/javascript'>
  //<![CDATA[
    google_ad_client = "ca-pub-5645564390194220";
    /* aalto_button */
    google_ad_slot = "5410151677";
    google_ad_width = 125;
    google_ad_height = 125;
  //]]>
</script>
</head>
<body>
<div id='main'>
<div id='header-wrapper'>
<div class='basic' id='header'>
<div class='title'>
Mobile Web Applications Development with HTML5
</div>
</div>
</div>
<div id='ads-wrapper'>
<div class='ads left'>
<script type='text/javascript'>
  //<![CDATA[
    google_ad_client = "ca-pub-5645564390194220";
    /* aalto_button */
    google_ad_slot = "5410151677";
    google_ad_width = 125;
    google_ad_height = 125;
  //]]>
</script>
<script src='http://pagead2.googlesyndication.com/pagead/show_ads.js' type='text/javascript'></script>
</div>
<div class='ads right'>
<script type='text/javascript'>
  //<![CDATA[
    google_ad_client = "ca-pub-5645564390194220";
    /* aalto_button */
    google_ad_slot = "5270550877";
    google_ad_width = 125;
    google_ad_height = 125;
  //]]>
</script>
<script src='http://pagead2.googlesyndication.com/pagead/show_ads.js' type='text/javascript'></script>
</div>
</div>
<div id='menu'>
<ul>
<li>
<a href='index.html#'>Home</a>
</li>
<li>
<a href='lectures.html'>Lectures</a>
</li>
<li>
<a href='index.html#Schedule'>Schedule</a>
</li>
<li>
<a href='examples.html'>Examples</a>
</li>
<li>
<a href='talks.html'>Talks</a>
</li>
<li>
<a href='resources.html'>Resources</a>
</li>
<li>
<a href='course_2012_1.html'>Spring 2012</a>
</li>
<li>
<a href='index.html#About'>About</a>
</li>
</ul>
</div>
<div id='wrapper'>
<a class='twitter-follow-button' data-show-count='false' data-show-screen-name='false' data-size='large' href='https://twitter.com/aaltowebapps'>Follow @aaltowebapps</a>
<div class='content-wrapper'>
<h1>WebSockets Chat Pusher</h1><div class='actions'><a href='http://high-day-2495.heroku.com/'>Try it</a><a href='https://github.com/aaltowebapps/MobileWebAppsExamples/tree/master/websocketsChatPusher'>Browse Source Code</a></div>
<p>
This example implements a chat service using
<a href='http://www.sinatrarb.com'>Sinatra</a>
for the backend and
<a href='http://pusher.com'>Pusher</a>
for sending the notifications to the clients
</p>
<p>
The client post the new messages to the REST URL
<span class='terminal'>/say</span>
by passing the following JSON data
<div class='terminal'>
{nickname: "guest", message: "Hello World"}
</div>
</p>
<p>
In the backend, the Sinatra server adds the timestamp to the message and sends it to the Pusher REST API for delivery.
The message is sent to the
<span class='terminal'>
chat
</span>
channel with the event
<span class='terminal'>
say
</span>
The Pusher service takes care of deliverying the message to all connected clients via the web socket.
Once the client receives the message, it is formatted and printed in the chat area
</p>
<p>
This example is live on Heroku at
<a href='http://high-day-2495.heroku.com/'>websocketsChatPusher</a>
How to deploy on Heroku is explained at the bottom of the page
</p>
<div class='code_block'>
<div class='code_header'>
Gemfile
</div>
<div class="CodeRay">
  <div class="code"><pre>source &quot;http://rubygems.org&quot;&#x000A;&#x000A;gem &quot;pusher&quot;&quot;&#x000A;gem &quot;sinatra&quot;&#x000A;</pre></div>
</div>
</div>
<div class='code_block'>
<div class='code_header'>
Terminal
</div>
<div class="CodeRay">
  <div class="code"><pre>ruby server.rb&#x000A;</pre></div>
</div>
</div>
<div class='code_block'>
<div class='code_header'>
websocketsChatPusher/server.rb
</div>
<div class="CodeRay">
  <div class="code"><pre>require <span class="string"><span class="delimiter">'</span><span class="content">sinatra</span><span class="delimiter">'</span></span>&#x000A;require <span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>&#x000A;require <span class="string"><span class="delimiter">'</span><span class="content">pusher</span><span class="delimiter">'</span></span>&#x000A;&#x000A;<span class="constant">Pusher</span>.app_id = <span class="string"><span class="delimiter">'</span><span class="content">13324</span><span class="delimiter">'</span></span>&#x000A;<span class="constant">Pusher</span>.key = <span class="string"><span class="delimiter">'</span><span class="content">8dc1dcd216474ec35b02</span><span class="delimiter">'</span></span>&#x000A;<span class="constant">Pusher</span>.secret = <span class="string"><span class="delimiter">'</span><span class="content">6ae6292fa86e2a559643</span><span class="delimiter">'</span></span>&#x000A;&#x000A;<span class="keyword">def</span> <span class="function">timestamp</span>&#x000A;  <span class="constant">Time</span>.now.strftime(<span class="string"><span class="delimiter">&quot;</span><span class="content">%H:%M:%S</span><span class="delimiter">&quot;</span></span>)&#x000A;<span class="keyword">end</span>&#x000A;&#x000A;get <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span> <span class="keyword">do</span> &#x000A;  <span class="comment">#Serve the chat client</span>&#x000A;  <span class="constant">File</span>.read(<span class="string"><span class="delimiter">'</span><span class="content">index.html</span><span class="delimiter">'</span></span>)&#x000A;<span class="keyword">end</span>&#x000A;&#x000A;post <span class="string"><span class="delimiter">'</span><span class="content">/say</span><span class="delimiter">'</span></span> <span class="keyword">do</span>&#x000A;  message = params.merge( {<span class="string"><span class="delimiter">'</span><span class="content">timestamp</span><span class="delimiter">'</span></span> =&gt; timestamp}).to_json&#x000A;&#x000A;  <span class="comment">#Use the REST Pusher API so pass the message that needs to be broadcasted</span>&#x000A;  <span class="comment">#to all clients that are connected to the chat channel</span>&#x000A;  <span class="constant">Pusher</span>[<span class="string"><span class="delimiter">'</span><span class="content">chat</span><span class="delimiter">'</span></span>].trigger(<span class="string"><span class="delimiter">'</span><span class="content">say</span><span class="delimiter">'</span></span>, message)&#x000A;<span class="keyword">end</span>&#x000A;</pre></div>
</div>
</div>
<div class='code_block'>
<div class='code_header'>
websocketsChatPusher/index.html.haml
</div>
<div class="CodeRay">
  <div class="code"><pre><span class="doctype">!!! 5</span>&#x000A;<span class="tag">%html</span>&#x000A;  <span class="tag">%head</span>&#x000A;    <span class="tag">%meta</span>(<span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%meta</span>(<span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">IE=edge,chrome=1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">http-equiv</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">X-UA-Compatible</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%meta</span>(<span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1</span><span class="delimiter">&quot;</span></span>)  &#x000A;    <span class="tag">%link</span>(<span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%script</span>(<span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://code.jquery.com/jquery-1.6.4.min.js</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%script</span>(<span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/javascript</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%script</span>(<span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://js.pusher.com/1.11/pusher.min.js</span><span class="delimiter">&quot;</span></span>)&#x000A;    <span class="tag">%title</span>&#x000A;      WebSockets Chat&#x000A;  <span class="tag">%body</span>&#x000A;<span class="comment">    :javascript</span>&#x000A;      <span class="predefined">$</span>(<span class="keyword">function</span>() {&#x000A;        <span class="keyword">var</span> pusher = <span class="keyword">new</span> Pusher(<span class="string"><span class="delimiter">'</span><span class="content">8dc1dcd216474ec35b02</span><span class="delimiter">'</span></span>); &#x000A;        <span class="keyword">var</span> chatChannel = pusher.subscribe(<span class="string"><span class="delimiter">'</span><span class="content">chat</span><span class="delimiter">'</span></span>);&#x000A;&#x000A;        chatChannel.bind(<span class="string"><span class="delimiter">'</span><span class="content">say</span><span class="delimiter">'</span></span>, <span class="keyword">function</span>(msg) {&#x000A;          <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#console</span><span class="delimiter">'</span></span>).prepend(<span class="string"><span class="delimiter">'</span><span class="content">&lt;p&gt;</span><span class="delimiter">'</span></span> + msg.timestamp + <span class="string"><span class="delimiter">'</span><span class="content"> &lt;strong&gt;</span><span class="delimiter">'</span></span> + msg.nickname + <span class="string"><span class="delimiter">'</span><span class="content">&lt;/strong&gt;: </span><span class="delimiter">'</span></span> + msg.message + <span class="string"><span class="delimiter">'</span><span class="content">&lt;/p&gt;</span><span class="delimiter">'</span></span>);&#x000A;        });&#x000A;        &#x000A;        <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#send</span><span class="delimiter">'</span></span>).click(<span class="keyword">function</span>(event) {&#x000A;          event.preventDefault();&#x000A;          <span class="keyword">var</span> msg = {<span class="key">nickname</span>: <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#nickname</span><span class="delimiter">'</span></span>).val(), <span class="key">message</span>: <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#message</span><span class="delimiter">'</span></span>).val()};&#x000A;          &#x000A;          <span class="predefined">$</span>.post( <span class="string"><span class="delimiter">'</span><span class="content">http://</span><span class="delimiter">'</span></span> + location.host + <span class="string"><span class="delimiter">'</span><span class="content">/say</span><span class="delimiter">'</span></span>,msg,<span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>);&#x000A;          <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#message</span><span class="delimiter">'</span></span>).val(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);&#x000A;        })  &#x000A;      });&#x000A;&#x000A;    <span class="tag">%div</span>(<span class="attribute-name">data-role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>)&#x000A;      <span class="tag">%div</span>(<span class="attribute-name">data-role</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">header</span><span class="delimiter">&quot;</span></span>)&#x000A;        <span class="tag">%h1</span> Simple Chat&#x000A;      <span class="tag">%input</span><span class="constant">#nickname</span>(<span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Nickname</span><span class="delimiter">&quot;</span></span>)&#x000A;      <span class="tag">%input</span><span class="constant">#message</span>(<span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Start chat here</span><span class="delimiter">&quot;</span></span>)&#x000A;      <span class="tag">%a</span><span class="constant">#send</span>(<span class="attribute-name">data-role</span> = <span class="string"><span class="delimiter">'</span><span class="content">button</span><span class="delimiter">'</span></span>)&#x000A;        Send&#x000A;      &#x000A;      <span class="constant">#console</span>&#x000A;    </pre></div>
</div>
</div>
<p>
To deploy this example on Heroku you can follow the following steps.
You must edit the index.html file and replace
<span class='terminal'>
localhost:4567
</span>
with the server URL that you create on Heroku (
<span class='terminal'>
high-day-2495.heroku.com
</span>
in the example below)
</p>
<div class='code_block'>
<div class='code_header'>
Terminal
</div>
<div class="CodeRay">
  <div class="code"><pre>$ mkdir scratch/pusherapp&#x000A;$ cd scratch/pusherapp&#x000A;$ cp examples/websocketsChatPusher/* .&#x000A;$ ls&#x000A;config.ru Gemfile index.html  index.html.haml server.rb&#x000A;$ heroku create&#x000A;Creating high-day-2495... done, stack is bamboo-mri-1.9.2&#x000A;http://high-day-2495.heroku.com/ | git@heroku.com:high-day-2495.git&#x000A;Git remote heroku added&#x000A;$ git init&#x000A;Initialized empty Git repository in /scratch/pusherapp/.git/&#x000A;$ git add .&#x000A;$ git commit -m &quot;sinatra app&quot;&#x000A;[master (root-commit) 397005f] sinatra app&#x000A; 4 files changed, 117 insertions(+), 0 deletions(-)&#x000A; create mode 100644 config.ru&#x000A; create mode 100644 Gemfile&#x000A; create mode 100644 index.html&#x000A; create mode 100644 index.html.haml&#x000A; create mode 100644 server.rb&#x000A;$ git push heroku master&#x000A;Counting objects: 9, done.&#x000A;Delta compression using up to 4 threads.&#x000A;Compressing objects: 100% (8/8), done.&#x000A;Writing objects: 100% (9/9), 2.30 KiB, done.&#x000A;Total 9 (delta 2), reused 0 (delta 0)&#x000A;&#x000A;-----&gt; Heroku receiving push&#x000A;-----&gt; Ruby/Sinatra app detected&#x000A;-----&gt; Compiled slug size is 4K&#x000A;-----&gt; Launching... done, v4&#x000A;       http://high-day-2495.heroku.com deployed to Heroku&#x000A;&#x000A;To git@heroku.com:high-day-2495.git&#x000A; * [new branch]      master -&gt; master</pre></div>
</div>
</div>

</div>
</div>
</div>
<div id='footer'>
<div class='sponsor'>
<a href='http://www.aalto.fi/'><img src='imgs/aaltouni.png' /></a>
<a href='http://www.nokia.com/'><img src='imgs/nokia.png' /></a>
<a href='http://www.sc5.io'><img src='imgs/SC5.jpg' /></a>
<a href='http://corporate.foreca.com/en/'><img src='imgs/foreca.png' /></a>
</div>
</div>
</body>
</html>
